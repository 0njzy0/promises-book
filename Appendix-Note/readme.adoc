[[editor-note]]
= Editor's Note

== Asciidoc

=== 表示用JavaScriptの生成

書籍のサンプルコードは外部ファイルにしたかった。
しかし、そのまま読み込む使い方だと、サンプルコードのモジュール化が難しくなってしまった。
モジュール化が上手くできないとテストを書くことが難しくなる。
そこで、サンプルコード(`src`)と表示用コード(`embed`)にわけることにした。

そのために、サンプルコードから表示用コードを生成するモジュールを書いた

- https://github.com/azu/inlining-node-require[azu/inlining-node-require]
- https://github.com/azu/remove-use-strict[azu/remove-use-strict]

__inlining-node-require__ はBrowserify等の既存のモジュールビルドツールではできない
CommonJSのキレイなコードの結合をするためのツール。

[NOTE]
ただし、あらゆるパターンに対応することはできないため、
ある程度の制限を持った書き方が必要になる。

サンプルコードは`"use strict"`を使ったコードとなっているが、
__inlining-node-require__ で結合した際に重複することや表示用コードではスペース的に余計なものとなる。
__remove-use-strict__ は不必要な`"use strict"`を取り除くことができるツール。

=== サンプルコード実行エディタ

Webで公開する書籍のメリットとして、その場でコードの実行結果が見られることが大きい。
書籍やウェブでの連載でもJSFiddle等のコード公開へのリンクを貼ったものが増えてきている。

そのため、サンプルコードがその場で実行できるのはメリットでありつつ、必要不可欠なものである。

日本語に対応したJavaScriptのコードエディタとしては http://codemirror.net/[CodeMirror] が良くできているため、
CodeMirrorをベースにコードの実行機能を付加するモジュールを作成した。

- https://github.com/azu/codemirror-console[azu/codemirror-console]
- https://github.com/azu/codemirror-console-ui[azu/codemirror-console-ui]

__codemirror-console__ はCodeMirrorに書かれているコードを実行出来るモジュール。
単純にコードをevalするだけでは、グロールスコープを汚染してしまうため、
コードを実行する時にiframeを作り、その中でコードを実行している。

http://nodejs.org/api/vm.html[Nodeのvmモジュール]と似た考え方を持つ https://github.com/amasad/context-eval/[context-eval]を利用した。
これにより単純に実行するだけではなく、`cosnole`を独自のものとすり替えて実行することができるようになっている。

__codemirror-console-ui__は__codemirror-console__のUIを提供するモジュール。

__codemirror-console__は実行する機能のみであるため、UIは別モジュールとして作成した。

image::img/javascript-console-editor.png[コンソールエディタの図]



== Testing

=== サンプルコードのテスト

- サンプルコードにテストコードが必要
- サンプルコードを埋め込み用のコードに変換して、外部ファイル読み込みで書籍に入れる

=== 出力したHTMLのテスト

- https://github.com/azu/promises-book/issues/25

=== Asciidoc上のインラインコードテスト

- https://github.com/azu/promises-book/issues/52

=== Asciidoctorのビルドテスト

- https://github.com/azu/promises-book/issues/54

== Review

=== プレビュー

masterへマージされたものは、Travis CIで自動的にビルドして`gh-pages`ブランチにpushされる。

- https://github.com/azu/promises-book/blob/master/_tools/deploy-gh-pages.sh[promises-book/_tools/deploy-gh-pages.sh at master · azu/promises-book]

pull-requests中のコミットは、`preview-html`ブランチに生成済みのHTMLがpushされる。

pushされた一時プレビュー用のURLをGitterに対して通知してpull-request時のプレビューが出来るようになってる。

image::img/preview-html.png[preview-html.png]

- https://github.com/azu/promises-book/blob/master/_tools/deploy-preview-html.sh[promises-book/_tools/deploy-preview-html.sh at master · azu/promises-book]

=== 依存関係の可視化

- https://github.com/azu/visualize-promises-book[azu/visualize-promises-book]

セクション毎にテーマを分けてる事が多いけど、それを俯瞰的にどうやってみるかを模索するために、
セクション同士の依存関係を可視化するものを作成した。

=== Lint

https://gist.github.com/inao/f55e8232e150aee918b9[WEB+DB PRESS用語統一ルール] の辞書を使うために、
辞書のパーサーを書いた

- https://github.com/azu/wzeditor-word-rules-parser[azu/wzeditor-word-rules-parser]
- http://efcl.info/2014/0616/res3931/[WEB+DB PRESS用語統一ルール(WZEditor)のパーサを書いた | Web scratch]

== Resources

https://github.com/w3ctag/promises-guide[w3ctag/promises-guide]::
    Promisesのガイド - 概念的な説明はここから得たものが多い

https://github.com/domenic/promises-unwrapping[domenic/promises-unwrapping]::
    ES6 Promisesの仕様リポジトリ - issueを検索して得た経緯や情報も多い

http://people.mozilla.org/~jorendorff/es6-draft.html#sec-promise-objects[ECMAScript Language Specification ECMA-262 6th Edition – DRAFT]::
    ES6 Promisesの仕様書 - 仕様書として参照する場合はこちらを優先した

http://www.html5rocks.com/en/tutorials/es6/promises/?redirect_from_locale=ja[JavaScript Promises: There and back again - HTML5 Rocks]::
    Promisesについての記事 - 完成度がとても高くサンプルコードやリファレンス等を参考にした

http://d.hatena.ne.jp/jovi0608/20140319/1395199285[Node.jsにPromiseが再びやって来た！ - ぼちぼち日記]::
    Node.jsとPromiseの記事 - __thenable__について参考にした